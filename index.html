<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>آيات - تطبيق حفظ القرآن الكريم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        /* ... (كل أنماط CSS السابقة تبقى كما هي) ... */
    </style>
</head>
<body>
    <!-- ... (كل HTML السابق يبقى كما هو حتى جزء السكربت) ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCoAixyqXO4nPapkhe0KUXGEJVgLZedHv4",
                authDomain: "ayat-8d3d0.firebaseapp.com",
                projectId: "ayat-8d3d0",
                storageBucket: "ayat-8d3d0.appspot.com",
                messagingSenderId: "201289603281",
                appId: "1:201289603281:web:17f89c18272290a068cdf0",
                measurementId: "G-0Y471DLJQK",
                databaseURL: "https://ayat-8d3d0-default-rtdb.firebaseio.com"
            };

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const auth = firebase.auth();
            
            // عناصر DOM
            const verseList = document.getElementById('verseList');
            const emptyState = document.getElementById('emptyState');
            const addVerseBtn = document.getElementById('addVerseBtn');
            const verseModal = document.getElementById('verseModal');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const verseForm = document.getElementById('verseForm');
            const loginBtn = document.getElementById('loginBtn');
            const syncBtn = document.getElementById('syncBtn');
            const syncStatus = document.getElementById('syncStatus');
            const authModal = document.getElementById('authModal');
            const closeAuthModal = document.getElementById('closeAuthModal');
            const cancelAuthBtn = document.getElementById('cancelAuthBtn');
            const authForm = document.getElementById('authForm');
            
            // بيانات التطبيق
            let verses = [];
            let isEditMode = false;
            let currentEditId = null;
            let currentUser = null;
            let syncInterval = null;

            // تحميل البيانات من localStorage
            function loadVerses() {
                const savedVerses = localStorage.getItem('quranVerses');
                if (savedVerses) {
                    try {
                        verses = JSON.parse(savedVerses);
                    } catch (e) {
                        verses = [];
                    }
                } else {
                    verses = [];
                }
                saveVersesToLocal();
                renderVerses(verses);
            }
            
            // حفظ البيانات في localStorage
            function saveVersesToLocal() {
                localStorage.setItem('quranVerses', JSON.stringify(verses));
                updateStats();
            }
            
            // عرض الآيات
            function renderVerses(versesToRender) {
                verseList.innerHTML = '';
                
                if (versesToRender.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    emptyState.style.display = 'none';
                    versesToRender.forEach(verse => {
                        const verseCard = document.createElement('div');
                        verseCard.className = `verse-card ${verse.status}`;
                        verseCard.setAttribute('draggable', 'true');
                        verseCard.setAttribute('data-id', verse.id);
                        
                        verseCard.innerHTML = `
                            <div class="verse-header">
                                <div>
                                    <div class="verse-title">${verse.name}</div>
                                    <div class="verse-surah">${verse.surah} ${verse.numbers ? `(${verse.numbers})` : ''}</div>
                                </div>
                                <span class="verse-status ${verse.status === 'memorized' ? 'status-memorized' : 'status-pending'}">
                                    ${verse.status === 'memorized' ? 'تم الحفظ' : 'قيد الحفظ'}
                                </span>
                            </div>
                            <div class="verse-text">${verse.text}</div>
                            <div class="verse-actions">
                                <div class="action-btns">
                                    <button class="action-btn edit-btn" data-id="${verse.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete-btn" data-id="${verse.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="action-btn status-btn" data-id="${verse.id}">
                                        <i class="fas ${verse.status === 'memorized' ? 'fa-undo' : 'fa-check'}"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        verseList.appendChild(verseCard);
                    });
                    
                    // إضافة event listeners للأزرار
                    setupEventListeners();
                }
            }

            function setupEventListeners() {
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.getAttribute('data-id'));
                        editVerse(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.getAttribute('data-id'));
                        deleteVerse(id);
                    });
                });
                
                document.querySelectorAll('.status-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.getAttribute('data-id'));
                        toggleVerseStatus(id);
                    });
                });

                // إعداد السحب والإفلات
                const verseCards = document.querySelectorAll('.verse-card');
                verseCards.forEach(card => {
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragover', handleDragOver);
                    card.addEventListener('dragenter', handleDragEnter);
                    card.addEventListener('dragleave', handleDragLeave);
                    card.addEventListener('drop', handleDrop);
                    card.addEventListener('dragend', handleDragEnd);
                });
            }

            // ... (وظائف السحب والإفلات تبقى كما هي) ...

            // فتح Modal لإضافة آية جديدة
            function openAddVerseModal() {
                isEditMode = false;
                currentEditId = null;
                document.getElementById('modalTitle').textContent = 'إضافة آية جديدة';
                verseForm.reset();
                verseModal.style.display = 'flex';
            }

            // تسجيل الدخول
            async function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    currentUser = userCredential.user;
                    authModal.style.display = 'none';
                    updateAuthUI();
                    fetchData();
                    
                    // بدء المزامنة التلقائية
                    if (syncInterval) clearInterval(syncInterval);
                    syncInterval = setInterval(syncData, 5000);
                } catch (error) {
                    document.getElementById('authMessage').textContent = 'خطأ في تسجيل الدخول: ' + error.message;
                    console.error('Login error:', error);
                }
            }

            // المزامنة مع Firebase
            async function syncData() {
                if (!currentUser) return;
                
                syncStatus.textContent = 'جاري المزامنة...';
                syncStatus.className = 'sync-status sync-loading';
                syncStatus.style.display = 'inline-block';
                
                try {
                    await database.ref(`users/${currentUser.uid}/verses`).set(verses);
                    syncStatus.textContent = 'تمت المزامنة';
                    syncStatus.className = 'sync-status sync-success';
                } catch (error) {
                    syncStatus.textContent = 'خطأ في المزامنة';
                    syncStatus.className = 'sync-status sync-error';
                    console.error('Sync error:', error);
                } finally {
                    setTimeout(() => {
                        syncStatus.style.display = 'none';
                    }, 3000);
                }
            }

            // ... (بقية الدوال تبقى كما هي) ...

            // تهيئة Event Listeners
            function initializeEventListeners() {
                addVerseBtn.addEventListener('click', openAddVerseModal);
                closeModal.addEventListener('click', () => verseModal.style.display = 'none');
                cancelBtn.addEventListener('click', () => verseModal.style.display = 'none');
                verseForm.addEventListener('submit', saveVerse);
                loginBtn.addEventListener('click', () => {
                    if (currentUser) {
                        auth.signOut().then(() => {
                            currentUser = null;
                            updateAuthUI();
                        });
                    } else {
                        authModal.style.display = 'flex';
                    }
                });
                syncBtn.addEventListener('click', syncData);
                closeAuthModal.addEventListener('click', () => authModal.style.display = 'none');
                cancelAuthBtn.addEventListener('click', () => authModal.style.display = 'none');
                authForm.addEventListener('submit', handleLogin);
            }

            // متابعة حالة المصادقة
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                updateAuthUI();
                if (user) {
                    fetchData();
                    if (syncInterval) clearInterval(syncInterval);
                    syncInterval = setInterval(syncData, 5000);
                } else if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }
            });

            // تحديث واجهة المستخدم حسب حالة المصادقة
            function updateAuthUI() {
                if (currentUser) {
                    loginBtn.textContent = 'تسجيل الخروج';
                    loginBtn.classList.remove('btn-primary');
                    loginBtn.classList.add('btn-danger');
                    syncBtn.style.display = 'flex';
                } else {
                    loginBtn.textContent = 'تسجيل الدخول';
                    loginBtn.classList.remove('btn-danger');
                    loginBtn.classList.add('btn-primary');
                    syncBtn.style.display = 'none';
                }
            }

            // تهيئة التطبيق
            initializeEventListeners();
            loadVerses();
            updateAuthUI();
        });
    </script>
</body>
</html>
